<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Spectre Tech</title>
    <link rel="icon" href="../logo-no-bg.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        spectre: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #22c55e; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #22c55e; color: white; border-radius: 8px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000; font-size: 14px; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: #ef4444; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .stat-card { transition: all 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .table-row:hover { background-color: #f8fafc; }
        .btn { transition: all 0.15s; }
        .btn:hover { transform: scale(1.02); }
        .btn:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Auth Check Overlay -->
    <div id="authOverlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-500 text-sm">Authenticating...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-spectre-600 to-spectre-700 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img src="../logo-no-bg.png" alt="Spectre" class="w-7 h-7" onerror="this.style.display='none'">
                <span class="font-bold text-lg">Spectre Admin</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="userEmail" class="text-xs bg-white/20 px-3 py-1 rounded-full hidden md:block"></span>
                <button onclick="refreshData()" class="btn bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Refresh
                </button>
                <button onclick="logout()" class="btn bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide">Total</p>
                        <h2 id="statTotal" class="text-2xl font-bold text-gray-800">0</h2>
                    </div>
                    <div class="bg-blue-100 p-2.5 rounded-lg">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    </div>
                </div>
            </div>
            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide">Completed</p>
                        <h2 id="statCompleted" class="text-2xl font-bold text-green-600">0</h2>
                    </div>
                    <div class="bg-green-100 p-2.5 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                </div>
            </div>
            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide">Failed</p>
                        <h2 id="statFailed" class="text-2xl font-bold text-red-600">0</h2>
                    </div>
                    <div class="bg-red-100 p-2.5 rounded-lg">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </div>
                </div>
            </div>
            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs uppercase tracking-wide">Revenue</p>
                        <h2 id="statRevenue" class="text-2xl font-bold text-gray-800">KSH 0</h2>
                    </div>
                    <div class="bg-yellow-100 p-2.5 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Actions -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
            <div class="flex flex-wrap gap-3 items-center">
                <div class="flex-1 min-w-[200px]">
                    <div class="relative">
                        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <input type="text" id="searchInput" placeholder="Search phone, M-Pesa code..." class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-spectre-500 focus:border-transparent">
                    </div>
                </div>
                <select id="statusFilter" class="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-spectre-500 bg-white">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
                <input type="date" id="fromDate" class="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-spectre-500">
                <input type="date" id="toDate" class="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-spectre-500">
                <button onclick="clearFilters()" class="text-gray-500 hover:text-gray-700 text-sm">Clear</button>
            </div>
            <div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-100">
                <button onclick="exportCSV()" class="btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    CSV
                </button>
                <button onclick="exportPDF()" class="btn bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    PDF
                </button>
                <button onclick="deleteSelected()" id="deleteBtn" class="btn bg-gray-200 text-gray-500 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1.5" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Delete (<span id="deleteCount">0</span>)
                </button>
                <div class="flex-1"></div>
                <span id="transactionCount" class="text-xs text-gray-500 self-center">0 transactions</span>
                <span id="lastUpdated" class="text-xs text-gray-400 self-center"></span>
            </div>
        </div>

        <!-- Transaction Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr>
                            <th class="px-3 py-3 text-left"><input type="checkbox" id="selectAll" class="rounded text-spectre-500 focus:ring-spectre-500"></th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reason</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">M-Pesa Code</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable" class="divide-y divide-gray-50">
                        <tr><td colspan="8" class="px-3 py-8 text-center text-gray-400"><div class="loader mx-auto mb-2"></div>Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="toast"><span id="toastMessage"></span></div>

    <!-- View Payment Modal -->
    <div id="viewModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">Transaction Details</h3>
                <button onclick="closeViewModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="viewModalContent" class="space-y-3 text-sm"></div>
            <button onclick="closeViewModal()" class="mt-4 w-full bg-spectre-500 hover:bg-spectre-600 text-white py-2 rounded-lg">Close</button>
        </div>
    </div>

    <!-- Firebase Client -->
    <script type="module">
        import { db, auth, COLLECTIONS } from '../firebase/client.js';
        import { collection, getDocs, doc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        let allPayments = [], filteredPayments = [], selectedIds = new Set();

        const authOverlay = document.getElementById('authOverlay');
        const statTotal = document.getElementById('statTotal');
        const statCompleted = document.getElementById('statCompleted');
        const statFailed = document.getElementById('statFailed');
        const statRevenue = document.getElementById('statRevenue');
        const transactionTable = document.getElementById('transactionTable');
        const transactionCount = document.getElementById('transactionCount');
        const lastUpdated = document.getElementById('lastUpdated');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const fromDate = document.getElementById('fromDate');
        const toDate = document.getElementById('toDate');
        const selectAll = document.getElementById('selectAll');
        const deleteBtn = document.getElementById('deleteBtn');
        const deleteCount = document.getElementById('deleteCount');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authOverlay.style.display = 'none';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userEmail').classList.remove('hidden');
                loadPayments();
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadPayments() {
            try {
                transactionTable.innerHTML = `<tr><td colspan="8" class="px-3 py-8 text-center text-gray-400"><div class="loader mx-auto mb-2"></div>Loading...</td></tr>`;
                const q = query(collection(db, COLLECTIONS.PAYMENTS), orderBy("createdAt", "desc"), limit(200));
                const snap = await getDocs(q);
                allPayments = [];
                snap.forEach(d => allPayments.push({ id: d.id, ...d.data() }));
                applyFilters();
                updateStats();
                lastUpdated.textContent = new Date().toLocaleTimeString();
            } catch (e) {
                console.error(e);
                transactionTable.innerHTML = `<tr><td colspan="8" class="px-3 py-8 text-center text-red-500">Error loading data</td></tr>`;
            }
        }

        function updateStats() {
            let completed = 0, failed = 0, revenue = 0;
            allPayments.forEach(p => {
                if (p.status === 'completed' || p.status === 'success') { completed++; revenue += parseFloat(p.amountRaw || p.amount || 0) || 0; }
                else if (p.status === 'failed' || p.status === 'cancelled') { failed++; }
            });
            statTotal.textContent = allPayments.length;
            statCompleted.textContent = completed;
            statFailed.textContent = failed;
            statRevenue.textContent = `KSH ${revenue.toLocaleString()}`;
        }

        function applyFilters() {
            const search = searchInput.value.toLowerCase().trim();
            const status = statusFilter.value;
            const start = fromDate.value ? new Date(fromDate.value) : null;
            const end = toDate.value ? new Date(toDate.value + 'T23:59:59') : null;

            filteredPayments = allPayments.filter(p => {
                if (search) {
                    const phone = (p.phone || p.phoneRaw || '').toLowerCase();
                    const code = (p.mpesaReceiptNumber || p.code || '').toLowerCase();
                    if (!phone.includes(search) && !code.includes(search)) return false;
                }
                if (status && p.status !== status) return false;
                if (start || end) {
                    const date = new Date(p.createdAt || p.date);
                    if (start && date < start) return false;
                    if (end && date > end) return false;
                }
                return true;
            });
            renderTable();
        }

        function renderTable() {
            if (filteredPayments.length === 0) {
                transactionTable.innerHTML = `<tr><td colspan="8" class="px-3 py-8 text-center text-gray-400">No transactions found</td></tr>`;
                transactionCount.textContent = '0 transactions';
                return;
            }
            transactionTable.innerHTML = filteredPayments.map(p => {
                const sc = p.status === 'completed' || p.status === 'success' ? 'bg-green-100 text-green-700' : p.status === 'failed' || p.status === 'cancelled' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';
                const d = p.createdAt ? new Date(p.createdAt) : null;
                const ds = d ? d.toLocaleDateString() : p.date || '-';
                const ts = d ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                return `<tr class="table-row">
                    <td class="px-3 py-2.5"><input type="checkbox" class="row-cb rounded text-spectre-500" data-id="${p.id}" ${selectedIds.has(p.id) ? 'checked' : ''}></td>
                    <td class="px-3 py-2.5 text-gray-600"><div class="text-xs">${ds}</div><div class="text-[10px] text-gray-400">${ts}</div></td>
                    <td class="px-3 py-2.5 font-medium text-gray-800">${p.phone || p.phoneRaw || '-'}</td>
                    <td class="px-3 py-2.5 font-semibold">${p.amount || `KES ${p.amountRaw || 0}`}</td>
                    <td class="px-3 py-2.5 text-gray-600 max-w-[120px] truncate" title="${p.reason || ''}">${p.reason || '-'}</td>
                    <td class="px-3 py-2.5"><span class="px-2 py-0.5 rounded-full text-xs font-medium ${sc}">${p.status || 'pending'}</span></td>
                    <td class="px-3 py-2.5 font-mono text-xs text-spectre-600">${p.mpesaReceiptNumber || p.code || '-'}</td>
                    <td class="px-3 py-2.5"><div class="flex gap-1">
                        <button onclick="viewPayment('${p.id}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                        <button onclick="deletePayment('${p.id}')" class="p-1 text-red-500 hover:bg-red-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div></td>
                </tr>`;
            }).join('');
            transactionCount.textContent = `${filteredPayments.length} of ${allPayments.length} transactions`;
            document.querySelectorAll('.row-cb').forEach(cb => {
                cb.addEventListener('change', e => { e.target.checked ? selectedIds.add(e.target.dataset.id) : selectedIds.delete(e.target.dataset.id); updateDeleteBtn(); });
            });
        }

        function updateDeleteBtn() {
            const c = selectedIds.size;
            deleteCount.textContent = c;
            deleteBtn.disabled = c === 0;
            deleteBtn.classList.toggle('bg-red-500', c > 0);
            deleteBtn.classList.toggle('text-white', c > 0);
            deleteBtn.classList.toggle('bg-gray-200', c === 0);
            deleteBtn.classList.toggle('text-gray-500', c === 0);
        }

        selectAll.addEventListener('change', e => {
            document.querySelectorAll('.row-cb').forEach(cb => { cb.checked = e.target.checked; e.target.checked ? selectedIds.add(cb.dataset.id) : selectedIds.delete(cb.dataset.id); });
            updateDeleteBtn();
        });

        searchInput.addEventListener('input', debounce(applyFilters, 300));
        statusFilter.addEventListener('change', applyFilters);
        fromDate.addEventListener('change', applyFilters);
        toDate.addEventListener('change', applyFilters);

        function debounce(fn, w) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), w); }; }

        window.refreshData = loadPayments;
        window.clearFilters = () => { searchInput.value = ''; statusFilter.value = ''; fromDate.value = ''; toDate.value = ''; applyFilters(); };
        
        window.viewPayment = id => {
            const p = allPayments.find(x => x.id === id);
            if (!p) return;
            document.getElementById('viewModalContent').innerHTML = `<div class="grid grid-cols-2 gap-2">
                <div class="text-gray-500">Phone:</div><div class="font-medium">${p.phone || p.phoneRaw || '-'}</div>
                <div class="text-gray-500">Amount:</div><div class="font-medium">${p.amount || `KES ${p.amountRaw}`}</div>
                <div class="text-gray-500">Reason:</div><div class="font-medium">${p.reason || '-'}</div>
                <div class="text-gray-500">Status:</div><div class="font-medium capitalize">${p.status || 'pending'}</div>
                <div class="text-gray-500">M-Pesa Code:</div><div class="font-medium text-spectre-600">${p.mpesaReceiptNumber || p.code || '-'}</div>
                <div class="text-gray-500">Date:</div><div class="font-medium">${p.date || new Date(p.createdAt).toLocaleDateString()}</div>
                <div class="text-gray-500">Time:</div><div class="font-medium">${p.time || new Date(p.createdAt).toLocaleTimeString()}</div>
            </div>`;
            document.getElementById('viewModal').classList.remove('hidden');
            document.getElementById('viewModal').classList.add('flex');
        };

        window.closeViewModal = () => { document.getElementById('viewModal').classList.add('hidden'); document.getElementById('viewModal').classList.remove('flex'); };

        window.deletePayment = async id => { if (!confirm('Delete this transaction?')) return; try { await deleteDoc(doc(db, COLLECTIONS.PAYMENTS, id)); showToast('Deleted'); loadPayments(); } catch (e) { showToast('Failed', true); } };

        window.deleteSelected = async () => {
            if (selectedIds.size === 0) return;
            if (!confirm(`Delete ${selectedIds.size} transaction(s)?`)) return;
            try { for (const id of selectedIds) { await deleteDoc(doc(db, COLLECTIONS.PAYMENTS, id)); } selectedIds.clear(); updateDeleteBtn(); showToast('Deleted'); loadPayments(); } catch (e) { showToast('Failed', true); }
        };

        window.exportCSV = () => {
            const h = ['Date', 'Phone', 'Amount', 'Reason', 'Status', 'M-Pesa Code'];
            const r = filteredPayments.map(p => [p.createdAt || p.date || '', p.phone || p.phoneRaw || '', p.amountRaw || p.amount || '', p.reason || '', p.status || '', p.mpesaReceiptNumber || p.code || '']);
            const csv = [h, ...r].map(x => x.map(c => `"${c}"`).join(',')).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`; a.click();
            showToast('CSV exported');
        };

        window.exportPDF = () => {
            if (!window.jspdf) { showToast('Loading...', true); return; }
            const { jsPDF } = window.jspdf, doc = new jsPDF();
            doc.setFontSize(16); doc.text('Spectre Tech - Transactions', 14, 20);
            doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
            let y = 40; doc.setFontSize(8); doc.setFont('helvetica', 'bold');
            doc.text('Date', 14, y); doc.text('Phone', 45, y); doc.text('Amount', 85, y); doc.text('Status', 110, y); doc.text('M-Pesa', 140, y);
            y += 6; doc.setFont('helvetica', 'normal');
            filteredPayments.slice(0, 50).forEach(p => {
                doc.text((p.date || '').substring(0, 12), 14, y); doc.text((p.phone || '').substring(0, 15), 45, y);
                doc.text(String(p.amountRaw || ''), 85, y); doc.text(p.status || '', 110, y); doc.text((p.mpesaReceiptNumber || '').substring(0, 12), 140, y);
                y += 5; if (y > 280) { doc.addPage(); y = 20; }
            });
            doc.save(`transactions_${new Date().toISOString().split('T')[0]}.pdf`); showToast('PDF exported');
        };

        window.logout = async () => { try { await signOut(auth); } catch (e) {} window.location.href = 'login.html'; };

        function showToast(m, e = false) { const t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = m; t.classList.toggle('error', e); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
