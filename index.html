<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectre Secure Payment - M-Pesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }

        .perspective-1000 {
            perspective: 1000px;
        }

        .preserve-3d {
            transform-style: preserve-3d;
        }

        .card-3d {
            transform: rotateX(0deg) rotateY(0deg);
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }

        .card-3d:hover {
            transform: translateZ(20px) scale(1.02);
            box-shadow: 0 25px 60px rgba(60, 179, 113, 0.3);
        }

        .mpesa-gradient {
            background: linear-gradient(135deg, #2d4a5e 0%, #3cb371 100%);
        }

        .dark-gradient {
            background: linear-gradient(135deg, #1a2634 0%, #2d4a5e 50%, #1e3a4f 100%);
        }

        .light-gradient {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
        }

        /* Light theme styles */
        .light-mode .card-3d {
            background: linear-gradient(135deg, #ffffff, #f8fafc, #f1f5f9) !important;
            border-color: rgba(60, 179, 113, 0.5) !important;
        }

        .light-mode .glow-green {
            box-shadow: 0 10px 40px rgba(60, 179, 113, 0.2), 0 0 40px rgba(45, 74, 94, 0.1);
        }

        .light-mode .text-white {
            color: #1e293b !important;
        }

        .light-mode .text-gray-400 {
            color: #64748b !important;
        }

        .light-mode .text-gray-500 {
            color: #475569 !important;
        }

        .light-mode .bg-gray-700 {
            background-color: #e2e8f0 !important;
            color: #1e293b !important;
        }

        .light-mode .bg-gray-800 {
            background-color: #f1f5f9 !important;
            color: #1e293b !important;
        }

        .light-mode .bg-gray-900 {
            background-color: #e2e8f0 !important;
        }

        .light-mode .border-gray-600 {
            border-color: #cbd5e1 !important;
        }

        .light-mode .border-gray-700 {
            border-color: #e2e8f0 !important;
        }

        .light-mode .glow-text {
            text-shadow: none;
            color: #2d4a5e !important;
        }

        .light-mode .input-3d {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.1), 
                        inset -1px -1px 3px rgba(255, 255, 255, 0.8);
        }

        .light-mode .particle {
            background: #3cb371;
        }

        /* Light mode for success modal */
        .light-mode .success-modal {
            background: rgba(255, 255, 255, 0.9);
        }

        .light-mode .success-modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
            border-color: rgba(60, 179, 113, 0.4) !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .light-mode .success-modal-content h3 {
            color: #1e293b !important;
        }

        .light-mode .success-modal-content p {
            color: #64748b !important;
        }

        .light-mode .receipt-section {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%) !important;
            border: 1px solid rgba(60, 179, 113, 0.2);
        }

        .light-mode .receipt-section span {
            color: #1e293b !important;
        }

        .light-mode .receipt-section .text-gray-400 {
            color: #64748b !important;
        }

        .light-mode .modal-receipt-code-bg {
            background: #ffffff !important;
            border: 1px solid #e2e8f0;
        }

        .light-mode .receipt-code-container {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 100%) !important;
            border: 1px solid rgba(60, 179, 113, 0.3);
        }

        .light-mode .receipt-code-container span {
            color: #166534 !important;
        }

        /* Light mode Make Another Payment button */
        .light-mode .make-another-btn {
            background: linear-gradient(135deg, #3cb371 0%, #2d9a5e 100%) !important;
            color: white !important;
        }

        /* Theme toggle switch */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle.light {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .theme-toggle-ball {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle.light .theme-toggle-ball {
            transform: translateX(30px);
        }

        .glow-green {
            box-shadow: 0 0 20px rgba(60, 179, 113, 0.3), 0 0 40px rgba(45, 74, 94, 0.2);
        }

        .glow-text {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #3cb371;
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        /* Money Flow Animation */
        .money-flow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .flow-dots {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
        }

        .flow-dot {
            width: 6px;
            height: 6px;
            background: #3cb371;
            border-radius: 50%;
            opacity: 0.3;
            animation: flowPulse 1.5s ease-in-out infinite;
        }

        .flow-dot:nth-child(1) { animation-delay: 0s; }
        .flow-dot:nth-child(2) { animation-delay: 0.2s; }
        .flow-dot:nth-child(3) { animation-delay: 0.4s; }
        .flow-dot:nth-child(4) { animation-delay: 0.6s; }
        .flow-dot:nth-child(5) { animation-delay: 0.8s; }

        @keyframes flowPulse {
            0%, 100% { 
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% { 
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 8px rgba(60, 179, 113, 0.6);
            }
        }

        .logo-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-box img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid rgba(60, 179, 113, 0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .logo-box span {
            font-size: 10px;
            font-weight: 600;
            margin-top: 4px;
        }

        .mpesa-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid rgba(60, 179, 113, 0.5);
        }

        .mpesa-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* Make Spectre logo same size as M-Pesa */
        .logo-box img {
            width: 50px !important;
            height: 50px !important;
            object-fit: cover;
        }

        @media (max-width: 640px) {
            .logo-box img, .mpesa-icon {
                width: 40px;
                height: 40px;
            }
            .mpesa-icon svg {
                width: 22px;
                height: 22px;
            }
            .flow-dot {
                width: 5px;
                height: 5px;
            }
            .logo-box span {
                font-size: 8px;
            }
        }

        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .success-check {
            animation: checkmark 0.5s ease-in-out forwards;
        }

        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }

        .input-3d {
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.3), 
                        inset -2px -2px 5px rgba(255, 255, 255, 0.1);
        }

        .btn-3d {
            box-shadow: 0 6px 0 #2d4a5e, 0 8px 20px rgba(60, 179, 113, 0.3);
            transform: translateY(0);
            transition: all 0.15s ease;
        }

        .btn-3d:active {
            box-shadow: 0 2px 0 #2d4a5e, 0 4px 10px rgba(60, 179, 113, 0.3);
            transform: translateY(4px);
        }

        /* Clean background pattern */
        .clean-bg {
            background: linear-gradient(180deg, #0f1a24 0%, #1a2634 50%, #0f1a24 100%);
            position: relative;
        }

        .clean-bg::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(60, 179, 113, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(45, 74, 94, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .light-mode.clean-bg {
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%) !important;
        }

        .light-mode.clean-bg::before {
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(60, 179, 113, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(45, 74, 94, 0.08) 0%, transparent 50%);
        }

        /* Smaller compact inputs */
        .input-compact {
            padding: 0.4rem 0.6rem !important;
            font-size: 0.8rem !important;
        }

        .label-compact {
            font-size: 0.65rem !important;
            margin-bottom: 0.2rem !important;
        }

        .prefix-compact {
            padding: 0.4rem 0.5rem !important;
            font-size: 0.75rem !important;
        }

        /* Print button styles */
        .print-btn {
            background: linear-gradient(135deg, #2d4a5e 0%, #1e3a4f 100%);
            border: 1px solid rgba(60, 179, 113, 0.3);
        }

        .print-btn:hover {
            background: linear-gradient(135deg, #3d5a6e 0%, #2e4a5f 100%);
        }

        .light-mode .print-btn {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%) !important;
            color: #1e293b !important;
        }

        .receipt-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .copy-tooltip {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        /* Desktop Visit Site - Fixed Top Right of Page */
        .visit-site-desktop {
            position: fixed;
            top: 25px;
            right: 30px;
            z-index: 9999;
            display: none;
        }

        @media (min-width: 641px) {
            .visit-site-desktop {
                display: block;
            }
        }

        /* Mobile Visit Site - Above Form */
        .visit-site-container {
            display: flex;
            justify-content: center;
            margin-top: 0.75rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 641px) {
            .visit-site-container {
                display: none;
            }
        }

        .visit-site-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(145deg, #3cb371, #2d9a5e);
            border-radius: 50px;
            box-shadow: 
                0 3px 12px rgba(60, 179, 113, 0.4),
                0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
        }

        .visit-site-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 5px 18px rgba(60, 179, 113, 0.5),
                0 3px 10px rgba(0, 0, 0, 0.25);
        }

        .visit-site-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .visit-site-btn .btn-icon {
            width: 14px;
            height: 14px;
            color: #ffffff;
        }

        .visit-site-btn .btn-text {
            color: #ffffff;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .light-mode .visit-site-btn {
            background: linear-gradient(145deg, #2d4a5e, #1e3a4f);
            box-shadow: 
                0 3px 12px rgba(45, 74, 94, 0.4),
                0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            body {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }

            .min-h-screen {
                min-height: auto !important;
                height: auto !important;
            }

            .mobile-top-align {
                align-items: flex-start !important;
                justify-content: flex-start !important;
                padding-top: 1.5rem !important;
                padding-bottom: 0.5rem !important;
                min-height: auto !important;
            }

            .card-3d {
                padding: 0.6rem !important;
                border-radius: 0.75rem !important;
                margin: 0 0.25rem;
            }

            .mb-3 {
                margin-bottom: 0.35rem !important;
            }

            .mb-4 {
                margin-bottom: 0.5rem !important;
            }

            .space-y-2 > * + * {
                margin-top: 0.35rem !important;
            }

            .glow-green {
                box-shadow: 0 0 8px rgba(60, 179, 113, 0.2), 0 0 12px rgba(45, 74, 94, 0.1);
            }

            .floating img {
                width: 3rem !important;
                height: 3rem !important;
            }

            #liveTime {
                font-size: 0.9rem !important;
            }

            #liveDate {
                font-size: 0.6rem !important;
            }

            .theme-toggle {
                width: 40px;
                height: 20px;
            }

            .theme-toggle-ball {
                width: 14px;
                height: 14px;
            }

            .theme-toggle.light .theme-toggle-ball {
                transform: translateX(20px);
            }

            /* Mobile: Pay button auto-width, centered */
            #payBtn {
                width: auto !important;
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }

            .pay-btn-container {
                display: flex;
                justify-content: center;
                margin-bottom: 1rem !important;
            }

            /* Mobile: Push Secure/Encrypted down */
            .secure-encrypted-text {
                margin-top: 1rem !important;
            }
        }

        /* Mobile bubble removed - using unified website-link instead */

        /* Download Toast Notification */
        .download-toast {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #3cb371, #2d9a5e);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 
                0 4px 25px rgba(60, 179, 113, 0.5),
                0 0 40px rgba(60, 179, 113, 0.3),
                0 0 60px rgba(60, 179, 113, 0.2);
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .download-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            animation: toastGlow 1.5s ease-in-out infinite alternate;
        }

        @keyframes toastGlow {
            from {
                box-shadow: 
                    0 4px 25px rgba(60, 179, 113, 0.5),
                    0 0 40px rgba(60, 179, 113, 0.3),
                    0 0 60px rgba(60, 179, 113, 0.2);
            }
            to {
                box-shadow: 
                    0 4px 30px rgba(60, 179, 113, 0.7),
                    0 0 50px rgba(60, 179, 113, 0.4),
                    0 0 80px rgba(60, 179, 113, 0.3);
            }
        }

        .download-toast svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Success Modal Overlay */
        .success-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .success-modal.show {
            display: flex;
        }

        .success-modal-content {
            background: linear-gradient(135deg, #1e3a4f 0%, #2d4a5e 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 320px;
            width: 100%;
            border: 1px solid rgba(60, 179, 113, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4), 0 0 30px rgba(60, 179, 113, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .receipt-section {
            background: linear-gradient(135deg, #3cb371/20 0%, #2d4a5e/40 100%);
            background: rgba(60, 179, 113, 0.15);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid rgba(60, 179, 113, 0.2);
        }

        /* Error Modal Styles */
        .error-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 1rem;
        }

        .error-modal.show {
            display: flex;
        }

        .error-modal-content {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3d 100%);
            border-radius: 1.25rem;
            padding: 2rem;
            max-width: 340px;
            width: 100%;
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(239, 68, 68, 0.15);
            animation: errorModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }

        @keyframes errorModalIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .error-icon-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.25rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: errorPulse 2s ease-in-out infinite;
        }

        @keyframes errorPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }

        .error-icon {
            width: 40px;
            height: 40px;
            color: #ef4444;
        }

        .error-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.75rem;
        }

        .error-message {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .error-type-container {
            margin-bottom: 1.5rem;
        }

        .error-type-badge-simple {
            display: inline-block;
            background: rgba(239, 68, 68, 0.15);
            color: #fca5a5;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .error-btn {
            width: 100%;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-weight: 600;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .error-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        /* Different error type colors */
        .error-modal-content.insufficient-funds .error-icon-container {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
        }
        .error-modal-content.insufficient-funds .error-icon {
            color: #f59e0b;
        }
        .error-modal-content.insufficient-funds {
            border-color: rgba(245, 158, 11, 0.3);
        }

        .error-modal-content.cancelled .error-icon-container {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));
        }
        .error-modal-content.cancelled .error-icon {
            color: #6b7280;
        }
        .error-modal-content.cancelled {
            border-color: rgba(107, 114, 128, 0.3);
        }

        .error-modal-content.timeout .error-icon-container {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
        }
        .error-modal-content.timeout .error-icon {
            color: #3b82f6;
        }
        .error-modal-content.timeout {
            border-color: rgba(59, 130, 246, 0.3);
        }

        /* Light mode error modal */
        .light-mode .error-modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
        }
        .light-mode .error-title {
            color: #1e293b;
        }
        .light-mode .error-message {
            color: #64748b;
        }

        /* Tablet and Desktop */
        @media (min-width: 641px) {
            .card-3d {
                padding: 2rem !important;
            }

            .success-modal-content {
                max-width: 380px;
                padding: 2rem;
            }

            .error-modal-content {
                max-width: 400px;
                padding: 2.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen clean-bg overflow-x-hidden">
    <!-- Visit Site Button (Desktop only: fixed top-right of page) -->
    <div class="visit-site-desktop">
        <a href="coming-soon.html" class="visit-site-btn">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
            </svg>
            <span class="btn-text">Visit Site</span>
        </a>
    </div>

    <!-- Main Container -->
    <div class="min-h-screen flex items-center justify-center p-3 perspective-1000 relative z-10 mobile-top-align">
        <div class="w-full max-w-[280px] sm:max-w-[320px] md:max-w-[380px] preserve-3d mx-auto">
            
            <!-- Header with Date/Time and Theme Toggle -->
            <div class="flex items-center justify-between mb-2 px-1">
                <!-- Live Date/Time Display -->
                <div class="text-center">
                    <div id="liveTime" class="text-lg font-bold text-white">12:00:00</div>
                    <div id="liveDate" class="text-xs text-[#3cb371] font-medium">3 Dec 2025 WED</div>
                </div>
                
                <!-- Theme Toggle -->
                <div class="flex items-center gap-3">
                    <span class="text-gray-400 text-sm">üåô</span>
                    <div id="themeToggle" class="theme-toggle">
                        <div class="theme-toggle-ball">
                            <span id="toggleIcon" class="text-xs">üåô</span>
                        </div>
                    </div>
                    <span class="text-gray-400 text-sm">‚òÄÔ∏è</span>
                </div>
            </div>

            <!-- Visit Site Button (Mobile only: above form) -->
            <div class="visit-site-container">
                <a href="coming-soon.html" class="visit-site-btn">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                    <span class="btn-text">Visit Site</span>
                </a>
            </div>
            
            <!-- Payment Card -->
            <div id="paymentCard" class="card-3d bg-gradient-to-br from-[#1a2634] via-[#243442] to-[#1a2634] rounded-2xl p-5 border border-[#3cb371]/30 glow-green">
                
                <!-- Logo Section - M-Pesa to Spectre Flow -->
                <div class="money-flow-container mb-4">
                    <!-- M-Pesa Logo -->
                    <div class="logo-box">
                        <div class="mpesa-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <span class="text-[#4CAF50]">M-PESA</span>
                    </div>

                    <!-- Flowing Dots -->
                    <div class="flow-dots">
                        <div class="flow-dot"></div>
                        <div class="flow-dot"></div>
                        <div class="flow-dot"></div>
                        <div class="flow-dot"></div>
                        <div class="flow-dot"></div>
                    </div>

                    <!-- Spectre Logo -->
                    <div class="logo-box floating">
                        <img src="logo.jpg" alt="Spectre Logo">
                        <span class="glow-text">SPECTRE</span>
                    </div>
                </div>

                <!-- Tagline -->
                <p class="text-center text-[#3cb371] text-xs mb-3">Reliable Tech Solutions</p>

                <!-- Step 1: Phone Number Input -->
                <div id="step1" class="space-y-2">
                    <div class="relative">
                        <label class="label-compact block text-[#3cb371] font-medium">Phone Number</label>
                        <div class="flex items-center">
                            <span class="prefix-compact bg-gray-700 text-white rounded-l-lg border border-r-0 border-gray-600">+254</span>
                            <input 
                                type="tel" 
                                id="phoneInput" 
                                placeholder="712 345 678"
                                maxlength="12"
                                class="input-compact input-3d w-full bg-gray-800 text-white rounded-r-lg border border-gray-600 focus:border-[#3cb371] focus:outline-none focus:ring-1 focus:ring-[#3cb371]/50 transition-all"
                            >
                        </div>
                        <p id="phoneError" class="text-red-400 text-xs mt-0.5 hidden">Please enter a valid phone number</p>
                    </div>

                    <div class="relative">
                        <label class="label-compact block text-[#3cb371] font-medium">Amount (KES)</label>
                        <input 
                            type="number" 
                            id="amountInput" 
                            placeholder="Enter amount (max 250,000)"
                            min="1"
                            max="250000"
                            class="input-compact input-3d w-full bg-gray-800 text-white rounded-lg border border-gray-600 focus:border-[#3cb371] focus:outline-none focus:ring-1 focus:ring-[#3cb371]/50 transition-all"
                        >
                        <p id="amountError" class="text-red-400 text-xs mt-0.5 hidden">Amount must be between 1 and 250,000</p>
                    </div>

                    <div class="relative">
                        <label class="label-compact block text-[#3cb371] font-medium">Payment Reason <span class="text-red-400">*</span></label>
                        <input 
                            type="text" 
                            id="reasonInput" 
                            placeholder="e.g. New laptop, Service fee"
                            maxlength="30"
                            pattern="[a-zA-Z0-9 ]*"
                            class="input-compact input-3d w-full bg-gray-800 text-white rounded-lg border border-gray-600 focus:border-[#3cb371] focus:outline-none focus:ring-1 focus:ring-[#3cb371]/50 transition-all"
                        >
                        <div class="flex justify-between items-center mt-0.5">
                            <p id="reasonError" class="text-red-400 text-xs hidden">Payment reason is required</p>
                            <span id="reasonCharCount" class="text-gray-500 text-xs ml-auto">0/30</span>
                        </div>
                    </div>

                    <div class="pay-btn-container">
                        <button 
                            id="payBtn"
                            class="btn-3d w-full mpesa-gradient text-white font-bold py-2 px-4 rounded-lg text-sm transition-all hover:brightness-110"
                        >
                            Pay with M-Pesa
                        </button>
                    </div>

                    <div class="secure-encrypted-text flex items-center justify-center gap-3 text-gray-400 text-xs mt-8">
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-[#3cb371]" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                            </svg>
                            <span>Secure</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-[#3cb371]" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                            <span>Encrypted</span>
                        </div>
                    </div>

                </div>

                <!-- Step 2: Processing STK Push -->
                <div id="step2" class="hidden space-y-4 text-center">
                    <div class="relative w-16 h-16 mx-auto">
                        <div class="absolute inset-0 border-3 border-[#3cb371]/30 rounded-full pulse-ring"></div>
                        <div class="absolute inset-0 border-3 border-[#3cb371]/30 rounded-full pulse-ring" style="animation-delay: 0.5s"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <svg class="w-8 h-8 text-[#3cb371] animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-base font-bold text-white">STK Push Sent!</h3>
                    <p class="text-gray-400 text-sm">Check your phone for the M-Pesa prompt</p>
                    <p class="text-[#3cb371] font-medium text-sm" id="displayPhone">+254 712 345 678</p>
                    <div class="flex items-center justify-center gap-2 text-yellow-400 text-sm">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>Waiting for confirmation...</span>
                    </div>
                    <div class="text-gray-500 text-xs">
                        <span id="countdown">60</span> seconds remaining
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="text-center mt-5">
                <p class="text-gray-500 text-xs">¬© 2025 Spectre Tech Limited. All rights reserved.</p>
                <div class="mt-2 text-gray-500 text-xs space-y-1">
                    <p>üìß spectretechlimited@gmail.com</p>
                    <p>üìû 0741739262</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="success-modal-content text-center">
            <div class="w-10 h-10 mx-auto bg-[#3cb371] rounded-full flex items-center justify-center mb-2">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-base font-bold text-white mb-1">Payment Successful!</h3>
            <p class="text-gray-400 text-xs mb-2">Transaction completed</p>
            
            <div class="receipt-section text-left text-xs space-y-1.5">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Amount</span>
                    <span class="text-white font-bold" id="modalAmount">KES 1,000</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Phone</span>
                    <span class="text-white" id="modalPhone">+254 712 345 678</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Reason</span>
                    <span class="text-white" id="modalReason">Service payment</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Date</span>
                    <span class="text-white" id="modalDate">Dec 3, 2025</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Time</span>
                    <span class="text-white" id="modalTime">12:00:00</span>
                </div>
                <div class="pt-1.5 border-t border-gray-600">
                    <p class="text-gray-400 text-xs mb-1">M-Pesa Receipt</p>
                    <div class="receipt-code-container flex items-center justify-between bg-[#1a2634] rounded-lg p-1.5">
                        <span class="text-[#3cb371] font-bold font-mono tracking-wider text-sm" id="modalCode">RKL7H9X2QP</span>
                        <button id="modalCopyBtn" class="bg-[#3cb371] hover:bg-[#2d9a5e] text-white px-2 py-0.5 rounded text-xs flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span id="modalCopyText">Copy</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 mt-3">
                <button id="printReceiptBtn" class="print-btn flex-1 text-white font-semibold py-1.5 px-3 rounded-lg text-xs transition-all flex items-center justify-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Print
                </button>
                <button id="modalCloseBtn" class="make-another-btn flex-1 bg-gradient-to-r from-[#3cb371] to-[#2d9a5e] hover:from-[#2d9a5e] hover:to-[#3cb371] text-white font-semibold py-1.5 px-3 rounded-lg text-xs transition-all">
                    New Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="error-modal">
        <div id="errorModalContent" class="error-modal-content">
            <!-- Error Icon Container -->
            <div class="error-icon-container">
                <svg id="errorIcon" class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>

            <!-- Error Title -->
            <h3 id="errorTitle" class="error-title">Payment Failed</h3>

            <!-- Error Message -->
            <p id="errorMessage" class="error-message">
                Something went wrong with your payment. Please try again.
            </p>

            <!-- Error Type Badge -->
            <div class="error-type-container">
                <span id="errorTypeBadge" class="error-type-badge-simple">Unknown Error</span>
            </div>

            <!-- Close Button -->
            <button id="errorCloseBtn" class="error-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Try Again
            </button>
        </div>
    </div>

    </div>

    <!-- Download Toast -->
    <div id="downloadToast" class="download-toast">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>Receipt Downloaded!</span>
    </div>

    <script>
        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const phoneInput = document.getElementById('phoneInput');
        const amountInput = document.getElementById('amountInput');
        const reasonInput = document.getElementById('reasonInput');
        const payBtn = document.getElementById('payBtn');
        const phoneError = document.getElementById('phoneError');
        const reasonError = document.getElementById('reasonError');
        const displayPhone = document.getElementById('displayPhone');
        const countdown = document.getElementById('countdown');
        const paymentCard = document.getElementById('paymentCard');
        
        // Modal Elements
        const successModal = document.getElementById('successModal');
        const modalAmount = document.getElementById('modalAmount');
        const modalPhone = document.getElementById('modalPhone');
        const modalReason = document.getElementById('modalReason');
        const modalDate = document.getElementById('modalDate');
        const modalTime = document.getElementById('modalTime');
        const modalCode = document.getElementById('modalCode');
        const modalCopyBtn = document.getElementById('modalCopyBtn');
        const modalCopyText = document.getElementById('modalCopyText');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const printReceiptBtn = document.getElementById('printReceiptBtn');

        // Store payment data for printing
        let currentPaymentData = {};

        // Generate random receipt code
        function generateReceiptCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 10; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Format phone number
        function formatPhone(phone) {
            const cleaned = phone.replace(/\s/g, '');
            return `+254 ${cleaned.slice(0, 3)} ${cleaned.slice(3, 6)} ${cleaned.slice(6)}`;
        }

        // Format amount
        function formatAmount(amount) {
            return `KES ${parseInt(amount).toLocaleString()}`;
        }

        // Format date
        function getCurrentDate() {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date().toLocaleDateString('en-US', options);
        }

        // Validate phone number
        function validatePhone(phone) {
            const cleaned = phone.replace(/\s/g, '');
            return cleaned.length >= 9 && /^\d+$/.test(cleaned);
        }

        // Phone input formatting
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 9) value = value.slice(0, 9);
            
            // Add spaces for formatting
            if (value.length > 6) {
                value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
            } else if (value.length > 3) {
                value = value.slice(0, 3) + ' ' + value.slice(3);
            }
            
            e.target.value = value;
            phoneError.classList.add('hidden');
        });

        // Amount input validation - limit to 6 figures (max 250,000)
        amountInput.addEventListener('input', (e) => {
            let value = parseInt(e.target.value);
            const amountError = document.getElementById('amountError');
            
            if (value > 250000) {
                e.target.value = 250000;
                amountError.classList.remove('hidden');
            } else if (value < 0) {
                e.target.value = '';
                amountError.classList.remove('hidden');
            } else {
                amountError.classList.add('hidden');
            }
        });

        // Pay button click
        payBtn.addEventListener('click', async () => {
            const phone = phoneInput.value;
            const amount = amountInput.value;
            const reason = reasonInput.value.trim();
            const amountError = document.getElementById('amountError');

            // Validate phone
            if (!validatePhone(phone)) {
                phoneError.classList.remove('hidden');
                phoneInput.parentElement.classList.add('shake');
                setTimeout(() => phoneInput.parentElement.classList.remove('shake'), 500);
                return;
            }

            // Validate amount - must be 1-250000
            if (!amount || amount <= 0 || amount > 250000) {
                amountError.classList.remove('hidden');
                amountInput.classList.add('shake');
                setTimeout(() => amountInput.classList.remove('shake'), 500);
                return;
            }
            amountError.classList.add('hidden');

            // Validate reason
            if (!reason) {
                reasonError.classList.remove('hidden');
                reasonInput.classList.add('shake');
                setTimeout(() => reasonInput.classList.remove('shake'), 500);
                return;
            }

            // Show step 2
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            displayPhone.textContent = formatPhone(phone);

            // Start countdown timer
            let timeLeft = 60;
            const timer = setInterval(() => {
                timeLeft--;
                countdown.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    handlePaymentFailure('Payment request timed out. Please try again.');
                }
            }, 1000);

            try {
                // API base URL - Vercel backend
                const apiBaseUrl = 'https://spectre-payment-server.vercel.app';
                console.log('üîó Using API:', apiBaseUrl);
                
                // Format phone for API (remove spaces, ensure format)
                const cleanPhone = phone.replace(/\s/g, '');
                const formattedPhone = cleanPhone.startsWith('0') ? cleanPhone : '0' + cleanPhone;

                // Send STK Push request
                console.log('üì± Sending STK Push request to:', `${apiBaseUrl}/api/stkpush`);
                
                // Sanitize reason - only alphanumeric and spaces, max 20 chars
                const cleanReason = reason.replace(/[^a-zA-Z0-9 ]/g, '').substring(0, 20) || 'Payment';
                
                const stkResponse = await fetch(`${apiBaseUrl}/api/stkpush`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: formattedPhone,
                        amount: parseInt(amount),
                        accountReference: 'SpectreTech',
                        transactionDesc: cleanReason
                    })
                });

                const stkData = await stkResponse.json();
                console.log('STK Response:', stkData);

                if (!stkData.success) {
                    clearInterval(timer);
                    handlePaymentFailure(stkData.error || 'Failed to send payment request');
                    return;
                }

                const checkoutRequestID = stkData.checkoutRequestID;
                console.log('‚úÖ STK Push sent! CheckoutRequestID:', checkoutRequestID);

                // Poll for payment status
                let pollCount = 0;
                const maxPolls = 12; // 12 polls x 5 seconds = 60 seconds
                
                const pollInterval = setInterval(async () => {
                    pollCount++;
                    console.log(`üîÑ Polling payment status... (${pollCount}/${maxPolls})`);

                    try {
                        const queryResponse = await fetch(`${apiBaseUrl}/api/query`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ checkoutRequestID })
                        });

                        const queryData = await queryResponse.json();
                        console.log('Query Response:', queryData);

                        if (queryData.status === 'success') {
                            clearInterval(timer);
                            clearInterval(pollInterval);
                            // Pass the M-Pesa receipt number from callback
                            await handlePaymentSuccess(phone, amount, reason, queryData.mpesaReceiptNumber);
                        } else if (queryData.status === 'cancelled') {
                            clearInterval(timer);
                            clearInterval(pollInterval);
                            handlePaymentFailure('Payment was cancelled by user.', phone, amount, reason);
                        } else if (queryData.status === 'failed') {
                            clearInterval(timer);
                            clearInterval(pollInterval);
                            // Pass the result code for better error detection
                            handlePaymentFailure(queryData.message || 'Payment failed.', phone, amount, reason, queryData.resultCode);
                        } else if (queryData.status === 'timeout') {
                            clearInterval(timer);
                            clearInterval(pollInterval);
                            handlePaymentFailure('Payment request timed out. Please try again.', phone, amount, reason);
                        }
                        // If still pending, continue polling

                    } catch (queryError) {
                        console.error('Query error:', queryError);
                    }

                    // Stop polling after max attempts
                    if (pollCount >= maxPolls) {
                        clearInterval(timer);
                        clearInterval(pollInterval);
                        handlePaymentFailure('Payment verification timed out. If you completed the payment, please contact support.', phone, amount, reason);
                    }
                }, 5000); // Poll every 5 seconds

            } catch (error) {
                clearInterval(timer);
                console.error('Payment error:', error);
                handlePaymentFailure(error.message || 'Failed to process payment. Please try again.', phone, amount, reason);
            }
        });

        // Error Modal Elements
        const errorModal = document.getElementById('errorModal');
        const errorModalContent = document.getElementById('errorModalContent');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const errorTypeBadge = document.getElementById('errorTypeBadge');
        const errorIcon = document.getElementById('errorIcon');
        const errorCloseBtn = document.getElementById('errorCloseBtn');

        // Error type configurations (user-friendly, no error codes shown)
        const errorConfigs = {
            'wrong_pin': {
                title: 'Wrong PIN Entered',
                message: 'The M-Pesa PIN you entered is incorrect. Please check your PIN and try again.',
                badge: 'Incorrect PIN',
                icon: 'lock',
                class: ''
            },
            'insufficient': {
                title: 'Insufficient Balance',
                message: 'Your M-Pesa account does not have enough funds to complete this transaction.',
                badge: 'Low Balance',
                icon: 'wallet',
                class: 'insufficient-funds'
            },
            'cancelled': {
                title: 'Payment Cancelled',
                message: 'You cancelled the payment request. No money was deducted from your account.',
                badge: 'Cancelled',
                icon: 'cancel',
                class: 'cancelled'
            },
            'timeout': {
                title: 'Request Timed Out',
                message: 'The payment request expired. Please try again.',
                badge: 'Expired',
                icon: 'clock',
                class: 'timeout'
            },
            'failed': {
                title: 'Payment Failed',
                message: 'The transaction could not be completed. Please check your M-Pesa and try again.',
                badge: 'Failed',
                icon: 'warning',
                class: ''
            },
            'default': {
                title: 'Payment Unsuccessful',
                message: 'We could not process your payment. Please try again.',
                badge: 'Error',
                icon: 'warning',
                class: ''
            }
        };

        // Icon SVG paths
        const iconPaths = {
            'lock': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>',
            'wallet': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>',
            'cancel': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
            'clock': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>',
            'warning': '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>'
        };

        // Detect error type from message (improved detection)
        function detectErrorType(message) {
            const lowerMsg = (message || '').toLowerCase();
            
            // Wrong PIN detection - check for specific M-Pesa error codes or messages
            if (lowerMsg.includes('wrong pin') || lowerMsg.includes('incorrect pin') || 
                lowerMsg.includes('invalid pin') || lowerMsg.includes('2001') ||
                (lowerMsg.includes('pin') && (lowerMsg.includes('incorrect') || lowerMsg.includes('wrong') || lowerMsg.includes('invalid')))) {
                return 'wrong_pin';
            }
            
            // Insufficient balance detection
            if (lowerMsg.includes('insufficient') || lowerMsg.includes('not enough') || 
                lowerMsg.includes('low balance') || lowerMsg.includes('balance') && lowerMsg.includes('funds')) {
                return 'insufficient';
            }
            
            // Timeout detection - request expired (check before cancelled to avoid false positives)
            if (lowerMsg.includes('timed out') || lowerMsg.includes('timeout') || 
                lowerMsg.includes('expired') || lowerMsg.includes('too long') ||
                lowerMsg.includes('verification timed out') || lowerMsg.includes('1037')) {
                return 'timeout';
            }
            
            // Cancelled detection - user rejected the request
            if (lowerMsg.includes('cancelled') || lowerMsg.includes('canceled') || 
                lowerMsg.includes('cancel') || lowerMsg.includes('rejected') || 
                lowerMsg.includes('declined') || lowerMsg.includes('1032')) {
                return 'cancelled';
            }
            
            // General failure detection
            if (lowerMsg.includes('failed') || lowerMsg.includes('unsuccessful') || 
                lowerMsg.includes('could not') || lowerMsg.includes('unable')) {
                return 'failed';
            }
            
            return 'default';
        }

        // Detect error type from result code (M-Pesa specific)
        function detectErrorFromResultCode(resultCode) {
            const code = String(resultCode);
            switch(code) {
                case '2001': return 'wrong_pin';
                case '1': return 'insufficient';
                case '1032': return 'cancelled';
                case '1037': return 'timeout';
                case '1025': return 'failed'; // Transaction limit exceeded
                default: return null;
            }
        }

        // Handle payment failure with styled modal
        async function handlePaymentFailure(message, phone = null, amount = null, reason = null, resultCode = null) {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            
            // Detect error type - first try result code, then fallback to message
            let errorType = null;
            if (resultCode) {
                errorType = detectErrorFromResultCode(resultCode);
            }
            if (!errorType) {
                errorType = detectErrorType(message);
            }
            
            const config = errorConfigs[errorType];
            
            // Save failed transaction to Firebase if we have the data
            if (phone && amount && window.savePaymentToFirebase) {
                const now = new Date();
                const failedPaymentData = {
                    phone: phone.replace(/(\d{3})(\d{3})(\d{3})/, '+254 $1 $2 $3'),
                    phoneRaw: phone,
                    amount: `KES ${parseInt(amount).toLocaleString()}`,
                    amountRaw: parseInt(amount),
                    reason: reason || 'Payment',
                    date: now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                    time: now.toLocaleTimeString('en-US', { hour12: false }),
                    status: 'failed',
                    failureReason: config.title,
                    failureMessage: message,
                    errorType: errorType,
                    resultCode: resultCode
                };
                
                try {
                    const result = await window.savePaymentToFirebase(failedPaymentData);
                    if (result.success) {
                        console.log("üìù Failed payment logged:", result.id);
                    }
                } catch (e) {
                    console.error("Could not log failed payment:", e);
                }
            }
            
            // Remove all error type classes
            errorModalContent.classList.remove('insufficient-funds', 'cancelled', 'timeout');
            if (config.class) {
                errorModalContent.classList.add(config.class);
            }
            
            // Update modal content (no error codes shown to user)
            errorTitle.textContent = config.title;
            errorMessage.textContent = config.message;
            errorTypeBadge.textContent = config.badge;
            errorIcon.innerHTML = iconPaths[config.icon];
            
            // Show the modal
            errorModal.classList.add('show');
        }

        // Close error modal handlers
        errorCloseBtn.addEventListener('click', () => {
            errorModal.classList.remove('show');
        });

        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                errorModal.classList.remove('show');
            }
        });

        // Handle payment success - now accepts mpesaReceiptNumber from callback
        async function handlePaymentSuccess(phone, amount, reason, mpesaReceiptNumber = null) {
            // Hide step 2 and show step 1 again
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            
            // Get current time
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            
            // Use real M-Pesa receipt number if available, otherwise generate fallback
            const receiptCode = mpesaReceiptNumber || generateReceiptCode();
            console.log('üìÑ M-Pesa Receipt Number:', receiptCode);
            
            // Store payment data for printing
            currentPaymentData = {
                amount: formatAmount(amount),
                amountRaw: parseInt(amount),
                phone: formatPhone(phone),
                phoneRaw: phone.replace(/\s/g, ''),
                reason: reason,
                date: getCurrentDate(),
                time: timeStr,
                code: receiptCode,
                mpesaReceiptNumber: mpesaReceiptNumber, // Store explicitly
                status: 'completed'
            };

            // Save payment to Firebase
            if (window.savePaymentToFirebase) {
                const result = await window.savePaymentToFirebase(currentPaymentData);
                if (result.success) {
                    console.log("‚úÖ Payment saved to Firebase:", result.id);
                } else {
                    console.error("‚ùå Failed to save payment:", result.error);
                }
            }
            
            // Populate and show success modal
            modalAmount.textContent = currentPaymentData.amount;
            modalPhone.textContent = currentPaymentData.phone;
            modalReason.textContent = currentPaymentData.reason;
            modalDate.textContent = currentPaymentData.date;
            modalTime.textContent = currentPaymentData.time;
            modalCode.textContent = currentPaymentData.code;
            successModal.classList.add('show');
            
            // Reset form
            phoneInput.value = '';
            amountInput.value = '';
            reasonInput.value = '';
        }

        // Modal copy button click
        modalCopyBtn.addEventListener('click', async () => {
            const code = modalCode.textContent;
            
            try {
                await navigator.clipboard.writeText(code);
                modalCopyText.textContent = 'Copied!';
                modalCopyBtn.style.backgroundColor = '#2d9a5e';
                
                setTimeout(() => {
                    modalCopyText.textContent = 'Copy';
                    modalCopyBtn.style.backgroundColor = '';
                }, 2000);
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                modalCopyText.textContent = 'Copied!';
                setTimeout(() => modalCopyText.textContent = 'Copy', 2000);
            }
        });

        // Modal close button
        modalCloseBtn.addEventListener('click', () => {
            successModal.classList.remove('show');
        });

        // Print Receipt Button - Direct PDF Download
        printReceiptBtn.addEventListener('click', async () => {
            try {
                // Check if jsPDF is loaded
                if (!window.jspdf) {
                    alert('PDF library loading... Please try again.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [80, 150]
                });

                // Colors
                const green = [60, 179, 113];
                const navy = [45, 74, 94];
                const gray = [100, 116, 139];
                const darkText = [30, 41, 59];

                // Load and add logo
                const loadImage = (url) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/png'));
                        };
                        img.onerror = () => resolve(null);
                        img.src = url;
                    });
                };

                // Try to load logo
                const logoData = await loadImage('logo-no-bg.png');
                
                if (logoData) {
                    // Logo on left, company name on right - horizontal layout
                    doc.addImage(logoData, 'PNG', 8, 5, 18, 11);
                    doc.setTextColor(...navy);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Spectre Tech', 28, 12);
                } else {
                    // Fallback to text header if logo fails
                    doc.setTextColor(...navy);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Spectre Tech', 40, 12, { align: 'center' });
                }

                // Decorative line under header
                doc.setDrawColor(...navy);
                doc.setLineWidth(0.4);
                doc.line(8, 19, 72, 19);

                // Success Badge - refined (wider to cover full text)
                doc.setFillColor(220, 252, 231);
                doc.roundedRect(10, 22, 60, 8, 2, 2, 'F');
                doc.setTextColor(22, 101, 52);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('Payment Successful', 40, 27, { align: 'center' });

                // Details section
                let y = 34;
                const details = [
                    ['Amount Paid', currentPaymentData.amount || 'N/A'],
                    ['Phone', currentPaymentData.phone || 'N/A'],
                    ['Reason', currentPaymentData.reason || 'N/A'],
                    ['Date', currentPaymentData.date || 'N/A'],
                    ['Time', currentPaymentData.time || 'N/A']
                ];

                doc.setFontSize(8);
                details.forEach(([label, value]) => {
                    doc.setTextColor(...gray);
                    doc.setFont('helvetica', 'normal');
                    doc.text(label, 10, y);
                    
                    doc.setTextColor(...darkText);
                    doc.setFont('helvetica', 'bold');
                    const truncatedValue = String(value).length > 18 ? String(value).substring(0, 18) + '...' : String(value);
                    doc.text(truncatedValue, 70, y, { align: 'right' });
                    
                    y += 8;
                });

                // Receipt Code Section
                y += 2;
                doc.setFillColor(...navy);
                doc.roundedRect(10, y, 60, 18, 3, 3, 'F');
                
                doc.setTextColor(148, 163, 184);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('M-PESA RECEIPT NUMBER', 40, y + 5, { align: 'center' });
                
                doc.setTextColor(...green);
                doc.setFontSize(12);
                doc.setFont('courier', 'bold');
                doc.text(currentPaymentData.code || 'N/A', 40, y + 13, { align: 'center' });

                // Footer
                y += 25;
                doc.setTextColor(...gray);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.text('Thank you for your payment!', 40, y, { align: 'center' });
                doc.text('spectretechlimited@gmail.com | 0741739262', 40, y + 4, { align: 'center' });

                // M-Pesa badge
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(25, y + 7, 30, 6, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(6);
                doc.text('Powered by M-PESA', 40, y + 11, { align: 'center' });

                // Download the PDF
                doc.save('Spectre_Receipt_' + (currentPaymentData.code || 'receipt') + '.pdf');

                // Show success toast
                const toast = document.getElementById('downloadToast');
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);

            } catch (error) {
                console.error('PDF Error:', error);
                alert('Download failed. Please try again.');
            }
        });

        // Character count element
        const reasonCharCount = document.getElementById('reasonCharCount');

        // Reason input validation with character count and filtering
        reasonInput.addEventListener('input', (e) => {
            // Filter out special characters (only allow alphanumeric and spaces)
            let value = e.target.value.replace(/[^a-zA-Z0-9 ]/g, '');
            
            // Prevent multiple consecutive spaces
            value = value.replace(/\s+/g, ' ');
            
            // Update input value if it was filtered
            if (e.target.value !== value) {
                e.target.value = value;
            }
            
            // Update character count
            const count = value.length;
            reasonCharCount.textContent = `${count}/30`;
            
            // Change color based on count
            if (count >= 28) {
                reasonCharCount.classList.remove('text-gray-500', 'text-yellow-500');
                reasonCharCount.classList.add('text-red-400');
            } else if (count >= 20) {
                reasonCharCount.classList.remove('text-gray-500', 'text-red-400');
                reasonCharCount.classList.add('text-yellow-500');
            } else {
                reasonCharCount.classList.remove('text-yellow-500', 'text-red-400');
                reasonCharCount.classList.add('text-gray-500');
            }
            
            // Hide error on valid input
            if (count > 0) {
                reasonError.classList.add('hidden');
            }
        });

        // Close modal on backdrop click
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                successModal.classList.remove('show');
            }
        });

        // Subtle 3D hover effect
        paymentCard.addEventListener('mouseenter', () => {
            paymentCard.style.transform = 'translateZ(20px) scale(1.02)';
        });

        paymentCard.addEventListener('mouseleave', () => {
            paymentCard.style.transform = 'rotateX(0deg) rotateY(0deg)';
        });

        // Add focus effects
        [phoneInput, amountInput, reasonInput].forEach(input => {
            input.addEventListener('focus', () => {
                input.parentElement.classList.add('ring-1', 'ring-[#3cb371]/50');
            });
            input.addEventListener('blur', () => {
                input.parentElement.classList.remove('ring-1', 'ring-[#3cb371]/50');
            });
        });

        // Live Date/Time Display
        const liveTime = document.getElementById('liveTime');
        const liveDate = document.getElementById('liveDate');
        
        function updateDateTime() {
            const now = new Date();
            
            // Time format: HH:MM:SS
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            liveTime.textContent = `${hours}:${minutes}:${seconds}`;
            
            // Date format: 3 Dec 2025 WED
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const dayName = days[now.getDay()];
            liveDate.textContent = `${day} ${month} ${year} ${dayName}`;
        }
        
        // Update immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const toggleIcon = document.getElementById('toggleIcon');
        let isDarkMode = true;

        if (themeToggle) {
            themeToggle.addEventListener('click', function(e) {
                e.preventDefault();
                isDarkMode = !isDarkMode;
                
                if (isDarkMode) {
                    document.body.classList.remove('light-mode');
                    themeToggle.classList.remove('light');
                    if (toggleIcon) toggleIcon.textContent = 'üåô';
                } else {
                    document.body.classList.add('light-mode');
                    themeToggle.classList.add('light');
                    if (toggleIcon) toggleIcon.textContent = '‚òÄÔ∏è';
                }
                console.log('Theme toggled. Dark mode:', isDarkMode);
            });
        }
    </script>


<!-- Firebase Client (consolidated) -->
<script type="module" src="firebase/client.js"></script>

<!-- Helper functions for payment flow -->
<script>
    // Wait for FirebaseAPI to be available
    function waitForFirebaseAPI(callback) {
        if (window.FirebaseAPI) {
            callback();
        } else {
            setTimeout(() => waitForFirebaseAPI(callback), 100);
        }
    }

    // Test Firebase connection (can be called from console)
    window.testFirebaseConnection = function() {
        waitForFirebaseAPI(async () => {
            const result = await window.FirebaseAPI.testConnection();
            if (result.success) {
                alert("‚úÖ Firebase connected successfully!\nDocument ID: " + result.id);
            } else {
                alert("‚ùå Firebase connection failed!\nError: " + result.error);
            }
        });
    };

    // Save payment to Firebase
    window.savePaymentToFirebase = async function(paymentData) {
        if (!window.FirebaseAPI) {
            console.error("FirebaseAPI not loaded yet");
            return { success: false, error: "API not ready" };
        }
        return await window.FirebaseAPI.savePayment(paymentData);
    };

    console.log("üîó Firebase helper functions loaded");
</script>



</body>
</html>